<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simplify</title>
    <link rel="stylesheet" href="../css/style.css">
    <script type="text/javascript" src="../../dist/paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas">

        var hitOptions = {
            segments: true,
            stroke: true,
            fill: false,
            tolerance: 10
        };

        var path, segment, closed;

        function onMouseDown(event) {
            if (path) {
                segment = null;
                
                var hitResult = path.hitTest(event.point, hitOptions);
                if (!hitResult)
                    return;
    
                if (hitResult) {
                    path = hitResult.item;

                    if (hitResult.type == 'segment') {
                        segment = hitResult.segment;
                    } else if (hitResult.type == 'stroke') {
                        var location = hitResult.location;
                        segment = path.insert(location.index + 1, event.point);
                    }

                    var offset = path.getOffsetOf(segment.point) || 0
                    debugger;
                    console.log(path.length);

                    var point1 = path.getPointAt(path.length < offset + 40 ? path.length : offset + 40);

                    // Create a small circle shaped path at the point:
                    new Path.Circle({
                        center: point1,
                        radius: 3,
                        fillColor: 'red'
                    });

                    var point2 = path.getPointAt(0 < offset - 40 ? offset - 40 : 0);

                    // Create a small circle shaped path at the point:
                    new Path.Circle({
                        center: point2,
                        radius: 3,
                        fillColor: 'blue'
                    });
                }
            } else {
                path = new Path({
                    segments: [event.point],
                    strokeColor: 'black'
                });
                path.selected = true;
            }
        }

        function onMouseDrag(event) {
            if (closed) {
                if (segment) {
                    segment.point = event.point;
                }
            } else {
                path.add(event.point);
            }
        }

        function onMouseUp(event) {
            if (closed) {

            } else {
                closed = true;
                path.closed = true;
                path.simplify();
            }
        }
    </script>
</head>
<body>
    <canvas id="canvas" resize></canvas>
</body>
</html>
